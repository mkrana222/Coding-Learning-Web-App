<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Quest - Learn SQL Like a Game!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Fredoka', sans-serif;
        }
        .bounce-in {
            animation: bounceIn 0.6s ease-out;
        }
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .pulse-success {
            animation: pulseSuccess 1s ease-in-out;
        }
        @keyframes pulseSuccess {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .sortable-ghost {
            opacity: 0.5;
            background: #e2e8f0 !important;
        }
        .sortable-chosen {
            transform: rotate(2deg);
            z-index: 1000;
        }
        .quiz-card {
            transition: all 0.3s ease;
            cursor: grab;
            min-height: 44px;
            min-width: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }
        .quiz-card:active {
            cursor: grabbing;
            transform: scale(1.05);
        }
        
        /* CRITICAL FIX: Ensure Build Query elements never get disabled styling */
        #drop-zone .quiz-card {
            opacity: 1 !important;
            pointer-events: auto !important;
            cursor: grab !important;
        }
        #drop-zone .quiz-card:active {
            cursor: grabbing !important;
        }
        .quiz-card.correct {
            animation: correctPulse 0.6s ease-out;
        }
        @keyframes correctPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); background-color: #10b981; }
            100% { transform: scale(1); }
        }
        .progress-bar {
            transition: width 1s ease-out;
        }
        
        /* MOBILE RESPONSIVE STYLES */
        
        /* Touch-friendly buttons and interactions */
        @media (max-width: 768px) {
            /* Larger touch targets for mobile */
            .quiz-card {
                padding: 12px 16px !important;
                margin: 6px !important;
                font-size: 16px !important;
                min-height: 50px;
                min-width: 90px;
                border-radius: 12px;
                font-weight: 700;
            }
            
            /* Larger buttons */
            button {
                min-height: 48px !important;
                padding: 12px 24px !important;
                font-size: 16px !important;
            }
            
            /* Stack quiz layout vertically */
            .quiz-container {
                flex-direction: column;
                gap: 24px;
            }
            
            /* Responsive drop zone */
            #drop-zone {
                min-height: 80px !important;
                padding: 16px !important;
            }
            
            #drop-zone .flex {
                min-height: 60px;
                gap: 8px;
            }
            
            /* Available parts container */
            #quiz-parts {
                justify-content: center !important;
                gap: 12px !important;
                padding: 16px;
            }
            
            /* Larger text and spacing */
            h1 { font-size: 3rem !important; }
            h2 { font-size: 2.5rem !important; }
            h3 { font-size: 2rem !important; }
            h4 { font-size: 1.5rem !important; }
            
            p, .text-lg { font-size: 18px !important; line-height: 1.6; }
            .text-xl { font-size: 22px !important; }
            
            /* Lesson cards */
            .lesson-card {
                padding: 24px !important;
                margin-bottom: 16px;
            }
            
            /* Syntax breakdown cards */
            .syntax-item {
                padding: 16px !important;
                margin-bottom: 12px;
                flex-direction: column;
                align-items: flex-start !important;
                gap: 12px;
            }
            
            .syntax-item .bg-blue-500,
            .syntax-item .bg-green-500,
            .syntax-item .bg-purple-500,
            .syntax-item .bg-orange-500,
            .syntax-item .bg-red-500,
            .syntax-item .bg-yellow-500,
            .syntax-item .bg-pink-500,
            .syntax-item .bg-indigo-500 {
                padding: 12px 16px !important;
                font-size: 16px !important;
                margin-bottom: 8px;
                width: 100%;
                text-align: center;
            }
            
            /* Navigation improvements */
            .nav-button {
                padding: 16px 24px !important;
                margin: 8px !important;
            }
            
            /* Table responsiveness */
            .data-table {
                font-size: 14px;
                overflow-x: auto;
            }
            
            .data-table th,
            .data-table td {
                padding: 12px 8px !important;
                min-width: 80px;
            }
            
            /* XP and progress */
            .xp-container {
                padding: 20px !important;
            }
            
            .progress-container {
                width: 200px !important;
                height: 6px !important;
            }
        }
        
        @media (max-width: 640px) {
            /* Extra small screens */
            .container {
                padding: 12px !important;
            }
            
            .quiz-card {
                padding: 14px 18px !important;
                margin: 8px !important;
                font-size: 15px !important;
                min-height: 52px;
                width: calc(100% - 16px);
                max-width: 280px;
            }
            
            /* Stack lesson grid to single column */
            #lessons-container {
                grid-template-columns: 1fr !important;
                gap: 16px !important;
            }
            
            /* Full width drop zone */
            #drop-zone {
                width: 100%;
                margin: 0;
            }
            
            /* Adjust homepage */
            .homepage-content {
                padding: 20px;
            }
            
            h1 { font-size: 2.5rem !important; }
            .text-8xl { font-size: 4rem !important; }
        }
        
        /* Mobile device specific styles */
        .mobile-device {
            font-size: 16px; /* Prevent zoom on input focus */
        }
        
        .touch-device {
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* Use viewport height units with fallback */
        .min-h-screen {
            min-height: 100vh;
            min-height: calc(var(--vh, 1vh) * 100);
        }
        
        /* Touch feedback */
        @media (hover: none) and (pointer: coarse) {
            .quiz-card:active {
                background-color: rgba(255, 255, 255, 0.2) !important;
                transform: scale(0.95);
            }
            
            button:active {
                transform: scale(0.95);
            }
            
            .lesson-card:active {
                transform: scale(0.95);
            }
            
            /* Disable hover effects on touch devices */
            .hover\:scale-105:hover {
                transform: none;
            }
            
            .hover\:bg-yellow-500:hover,
            .hover\:bg-blue-600:hover,
            .hover\:bg-green-600:hover {
                background-color: inherit;
            }
        }
        
        /* Enhanced mobile interactions */
        @media (max-width: 768px) {
            /* Larger hit areas for better touch */
            button, .btn {
                padding: 14px 20px !important;
                margin: 8px 4px !important;
            }
            
            /* Better spacing for thumbs */
            .quiz-card {
                margin: 8px !important;
            }
            
            /* Prevent horizontal scroll */
            body {
                overflow-x: hidden;
            }
            
            /* Better contrast on mobile */
            .text-gray-600 {
                color: #4b5563 !important;
            }
            
            .text-gray-500 {
                color: #6b7280 !important;
            }
        }
        
        /* Improved sortable ghost for mobile */
        .sortable-ghost {
            opacity: 0.3 !important;
            background: rgba(59, 130, 246, 0.2) !important;
            border: 2px dashed #3b82f6 !important;
            transform: scale(1.1);
        }
        
        /* Better visual feedback for dragging */
        .sortable-chosen {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            transform: rotate(3deg) scale(1.05);
        }
        
        /* Prevent text selection during drag */
        .quiz-card * {
            pointer-events: none;
            user-select: none;
            -webkit-user-select: none;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-400 via-pink-500 to-red-500 min-h-screen">
    <!-- Homepage -->
    <div id="homepage" class="min-h-screen flex items-center justify-center p-4">
        <div class="homepage-content text-center bounce-in">
            <div class="mb-8">
                <div class="text-8xl mb-4">🗃️</div>
                <h1 class="text-6xl font-bold text-white mb-4 drop-shadow-lg">SQL Quest</h1>
                <p class="text-xl text-white mb-8 drop-shadow max-w-md mx-auto">
                    Learn SQL like a game! Master database queries with fun, interactive lessons designed for beginners.
                </p>
            </div>
            <button onclick="showLessons()" class="bg-yellow-400 hover:bg-yellow-500 text-purple-800 font-bold py-4 px-8 rounded-full text-xl shadow-lg transform hover:scale-105 transition-all duration-300">
                🚀 Start Learning!
            </button>
        </div>
    </div>

    <!-- Lesson List -->
    <div id="lesson-list" class="hidden min-h-screen p-4 bg-gradient-to-br from-blue-400 via-purple-500 to-pink-500">
        <div class="max-w-4xl mx-auto">
            <div class="text-center mb-8">
                <button onclick="showHomepage()" class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg mb-4 transition-all duration-300">
                    ← Back to Home
                </button>
                <h2 class="text-4xl font-bold text-white mb-2">Your SQL Journey</h2>
                <div class="bg-white/20 rounded-full p-4 inline-block">
                    <div class="text-white">
                        <span class="text-2xl font-bold" id="xp-display">0</span> XP
                        <div class="w-64 bg-white/20 rounded-full h-4 mt-2">
                            <div id="progress-bar" class="bg-yellow-400 h-4 rounded-full progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="lessons-container" class="grid gap-6 sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
                <!-- Lessons will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Lesson Content -->
    <div id="lesson-content" class="hidden min-h-screen p-4 bg-gradient-to-br from-green-400 via-blue-500 to-purple-600">
        <div class="max-w-4xl mx-auto">
            <div class="text-center mb-8">
                <button onclick="showLessons()" class="nav-button bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg mb-4 transition-all duration-300">
                    ← Back to Lessons
                </button>
            </div>
            
            <!-- Explanation Phase -->
            <div id="explanation-phase" class="bg-white rounded-3xl shadow-xl p-8 mb-8">
                <div class="text-center mb-6">
                    <div class="text-6xl mb-4" id="lesson-emoji">📚</div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-2" id="lesson-title"></h3>
                    <p class="text-lg text-gray-600" id="lesson-concept"></p>
                </div>
                
                <div class="bg-blue-50 rounded-2xl p-6 mb-6">
                    <h4 class="text-xl font-semibold text-blue-800 mb-3">Let's Learn! 🎓</h4>
                    <p class="text-gray-700 text-lg" id="lesson-explanation"></p>
                </div>
                
                <div class="bg-gray-50 rounded-2xl p-6 mb-6">
                    <h4 class="text-xl font-semibold text-gray-800 mb-3">Example Query:</h4>
                    <div class="bg-gray-800 text-green-400 p-4 rounded-lg font-mono text-lg" id="example-query"></div>
                    <p class="text-gray-600 mt-3" id="example-explanation"></p>
                </div>
                
                <!-- Sample Data Table -->
                <div id="sample-data" class="bg-yellow-50 rounded-2xl p-6 mb-6">
                    <h4 class="text-xl font-semibold text-yellow-800 mb-3">Sample Data 📊</h4>
                    <div id="data-table" class="data-table overflow-x-auto"></div>
                </div>
                
                <!-- Syntax Breakdown -->
                <div id="syntax-breakdown" class="bg-purple-50 rounded-2xl p-6 mb-6">
                    <h4 class="text-xl font-semibold text-purple-800 mb-3">Understanding Each Part 🧩</h4>
                    <div id="breakdown-content" class="space-y-3"></div>
                </div>
                
                <div class="text-center">
                    <button onclick="startQuiz()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg transform hover:scale-105 transition-all duration-300">
                        Ready for the Quiz! 🧩
                    </button>
                </div>
            </div>
            
            <!-- Quiz Phase -->
            <div id="quiz-phase" class="hidden bg-white rounded-3xl shadow-xl p-8">
                <div class="text-center mb-6">
                    <div class="text-6xl mb-4">🧩</div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-2">Quiz Time!</h3>
                    <p class="text-lg text-gray-600">Drag the parts below to build the correct SQL query</p>
                </div>
                
                <div class="quiz-container mb-8 flex flex-col lg:flex-row gap-8">
                    <div class="flex-1">
                        <h4 class="text-xl font-semibold text-gray-800 mb-4">Build this query:</h4>
                        <div class="bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg p-4 min-h-16" id="drop-zone">
                            <div class="flex flex-wrap gap-2 justify-center items-center min-h-12">
                                <p class="text-gray-500 text-center w-full" id="drop-hint">Drag query parts here (arrange horizontally)</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex-1">
                        <h4 class="text-xl font-semibold text-gray-800 mb-4">Available Parts:</h4>
                        <div id="quiz-parts" class="flex flex-wrap gap-4 justify-center">
                            <!-- Quiz parts will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
                
                <div class="text-center">
                    <button onclick="checkAnswer()" id="check-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg transform hover:scale-105 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Check Answer 🔍
                    </button>
                </div>
                
                <div id="result-message" class="hidden mt-6 text-center p-4 rounded-lg font-bold text-lg"></div>
            </div>
        </div>
    </div>

    <script>
        // Application State
        let currentLesson = null;
        let userProgress = { completed: [], xp: 0 };
        let sortableInstance = null;
        let droppedParts = [];
        let usedParts = new Set(); // Track which parts are currently used
        
        // Lesson Data
        const lessons = [
            {
                id: 1,
                title: "What is SELECT?",
                concept: "SELECT Basics",
                emoji: "🔍",
                explanation: "SELECT is like asking 'Show me!' to the database. It's the magic word that tells the database you want to see some information! Think of it like asking a librarian to show you books.",
                example_query: "SELECT * FROM users",
                example_explanation: "This means: 'Show me everything (*) from the users table'",
                syntax_breakdown: [
                    { part: "SELECT", color: "bg-blue-500", explanation: "Points to what you want to see - like raising your hand to ask for something!" },
                    { part: "*", color: "bg-green-500", explanation: "Means 'everything' - like asking for all the cookies in the jar!" },
                    { part: "FROM", color: "bg-purple-500", explanation: "Shows where to look - like telling someone which box to check!" },
                    { part: "users", color: "bg-orange-500", explanation: "The name of the table - like the label on a filing cabinet!" }
                ],
                quiz_parts: [
                    { text: "SELECT", order: 1, color: "bg-blue-500" },
                    { text: "*", order: 2, color: "bg-green-500" },
                    { text: "FROM", order: 3, color: "bg-purple-500" },
                    { text: "users", order: 4, color: "bg-orange-500" }
                ],
                locked: false,
                sampleTable: 'users'
            },
            {
                id: 2,
                title: "Choosing Columns",
                concept: "SELECT Specific Columns",
                emoji: "🎯",
                explanation: "Instead of asking for everything (*), we can ask for specific things! It's like asking for just the names instead of all the information about people.",
                example_query: "SELECT name, age FROM users",
                example_explanation: "This means: 'Show me only the name and age columns from the users table'",
                syntax_breakdown: [
                    { part: "SELECT", color: "bg-blue-500", explanation: "Points to what you want to see" },
                    { part: "name, age", color: "bg-green-500", explanation: "Specific things you want - separated by commas like items in a shopping list!" },
                    { part: "FROM", color: "bg-purple-500", explanation: "Shows where to look" },
                    { part: "users", color: "bg-orange-500", explanation: "The table name" }
                ],
                quiz_parts: [
                    { text: "SELECT", order: 1, color: "bg-blue-500" },
                    { text: "name, age", order: 2, color: "bg-green-500" },
                    { text: "FROM", order: 3, color: "bg-purple-500" },
                    { text: "users", order: 4, color: "bg-orange-500" }
                ],
                locked: true,
                sampleTable: 'users'
            },
            {
                id: 3,
                title: "FROM Which Table?",
                concept: "Understanding FROM",
                emoji: "📂",
                explanation: "FROM tells the database which table (like a filing cabinet) to look in. Every query needs to know where to look! It's like telling someone which drawer to search in.",
                example_query: "SELECT title FROM books",
                example_explanation: "This means: 'Show me the title column from the books table'",
                syntax_breakdown: [
                    { part: "SELECT", color: "bg-blue-500", explanation: "Points to what you want to see" },
                    { part: "title", color: "bg-green-500", explanation: "The specific column we want to see" },
                    { part: "FROM", color: "bg-purple-500", explanation: "Shows where to look - this is very important!" },
                    { part: "books", color: "bg-orange-500", explanation: "The table name - like choosing which bookshelf to look at!" }
                ],
                quiz_parts: [
                    { text: "SELECT", order: 1, color: "bg-blue-500" },
                    { text: "title", order: 2, color: "bg-green-500" },
                    { text: "FROM", order: 3, color: "bg-purple-500" },
                    { text: "books", order: 4, color: "bg-orange-500" }
                ],
                locked: true,
                sampleTable: 'books'
            },
            {
                id: 4,
                title: "WHERE Conditions",
                concept: "Filtering with WHERE",
                emoji: "🔎",
                explanation: "WHERE is like a filter! It helps us find only the information we want, like finding all books by a specific author or people of a certain age.",
                example_query: "SELECT * FROM users WHERE age > 18",
                example_explanation: "This means: 'Show me everything from users table, but only for people older than 18'",
                syntax_breakdown: [
                    { part: "SELECT", color: "bg-blue-500", explanation: "Points to what you want to see" },
                    { part: "*", color: "bg-green-500", explanation: "Everything in the table" },
                    { part: "FROM", color: "bg-purple-500", explanation: "Shows where to look" },
                    { part: "users", color: "bg-orange-500", explanation: "The table name" },
                    { part: "WHERE", color: "bg-red-500", explanation: "Sets up a rule - like saying 'only if...'!" },
                    { part: "age > 18", color: "bg-yellow-500", explanation: "The rule itself - only people older than 18!" }
                ],
                quiz_parts: [
                    { text: "SELECT", order: 1, color: "bg-blue-500" },
                    { text: "*", order: 2, color: "bg-green-500" },
                    { text: "FROM", order: 3, color: "bg-purple-500" },
                    { text: "users", order: 4, color: "bg-orange-500" },
                    { text: "WHERE", order: 5, color: "bg-red-500" },
                    { text: "age > 18", order: 6, color: "bg-yellow-500" }
                ],
                locked: true,
                sampleTable: 'users'
            },
            {
                id: 5,
                title: "ORDER BY Sorting",
                concept: "Sorting Results",
                emoji: "📋",
                explanation: "ORDER BY arranges our results in order, like organizing books alphabetically by title or arranging people by age from youngest to oldest!",
                example_query: "SELECT * FROM users ORDER BY name",
                example_explanation: "This means: 'Show me everything from users table, arranged alphabetically by name'",
                syntax_breakdown: [
                    { part: "SELECT", color: "bg-blue-500", explanation: "Points to what you want to see" },
                    { part: "*", color: "bg-green-500", explanation: "Everything in the table" },
                    { part: "FROM", color: "bg-purple-500", explanation: "Shows where to look" },
                    { part: "users", color: "bg-orange-500", explanation: "The table name" },
                    { part: "ORDER BY", color: "bg-pink-500", explanation: "Says 'arrange these in order' - like sorting your toys!" },
                    { part: "name", color: "bg-indigo-500", explanation: "What to sort by - alphabetically by name!" }
                ],
                quiz_parts: [
                    { text: "SELECT", order: 1, color: "bg-blue-500" },
                    { text: "*", order: 2, color: "bg-green-500" },
                    { text: "FROM", order: 3, color: "bg-purple-500" },
                    { text: "users", order: 4, color: "bg-orange-500" },
                    { text: "ORDER BY", order: 5, color: "bg-pink-500" },
                    { text: "name", order: 6, color: "bg-indigo-500" }
                ],
                locked: true,
                sampleTable: 'users'
            }
        ];
        
        // Sample Data
        const sampleData = {
            users: [
                { id: 1, name: "Alice", age: 25, city: "New York" },
                { id: 2, name: "Bob", age: 30, city: "London" },
                { id: 3, name: "Charlie", age: 22, city: "Paris" }
            ],
            books: [
                { id: 1, title: "Harry Potter", author: "J.K. Rowling", year: 1997 },
                { id: 2, title: "Lord of the Rings", author: "J.R.R. Tolkien", year: 1954 },
                { id: 3, title: "The Hobbit", author: "J.R.R. Tolkien", year: 1937 }
            ]
        };
        
        // Navigation Functions
        function showHomepage() {
            hideAll();
            document.getElementById('homepage').classList.remove('hidden');
        }
        
        function showLessons() {
            hideAll();
            document.getElementById('lesson-list').classList.remove('hidden');
            renderLessons();
            updateProgress();
        }
        
        function showLesson(lessonId) {
            currentLesson = lessons.find(l => l.id === lessonId);
            if (!currentLesson) return;
            
            hideAll();
            document.getElementById('lesson-content').classList.remove('hidden');
            renderLesson();
        }
        
        function hideAll() {
            document.getElementById('homepage').classList.add('hidden');
            document.getElementById('lesson-list').classList.add('hidden');
            document.getElementById('lesson-content').classList.add('hidden');
            document.getElementById('explanation-phase').classList.remove('hidden');
            document.getElementById('quiz-phase').classList.add('hidden');
        }
        
        // Render Functions
        function renderLessons() {
            const container = document.getElementById('lessons-container');
            container.innerHTML = '';
            
            lessons.forEach(lesson => {
                const isUnlocked = !lesson.locked || userProgress.completed.includes(lesson.id - 1);
                const isCompleted = userProgress.completed.includes(lesson.id);
                
                const lessonCard = document.createElement('div');
                lessonCard.className = `lesson-card bg-white rounded-xl shadow-lg p-6 transform transition-all duration-300 hover:scale-105 slide-in ${
                    isUnlocked ? 'cursor-pointer' : 'opacity-50 cursor-not-allowed'
                }`;
                
                lessonCard.innerHTML = `
                    <div class="text-center">
                        <div class="text-4xl mb-3">${lesson.emoji}</div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">${lesson.title}</h3>
                        <p class="text-gray-600 mb-4">${lesson.concept}</p>
                        <div class="flex items-center justify-center space-x-2">
                            ${isCompleted ? 
                                '<span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium">✓ Completed</span>' :
                                isUnlocked ?
                                    '<span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">Start</span>' :
                                    '<span class="bg-gray-100 text-gray-500 px-3 py-1 rounded-full text-sm font-medium">🔒 Locked</span>'
                            }
                        </div>
                    </div>
                `;
                
                if (isUnlocked) {
                    lessonCard.addEventListener('click', () => showLesson(lesson.id));
                    
                    // Add touch feedback for mobile
                    lessonCard.addEventListener('touchstart', function() {
                        this.style.transform = 'scale(0.98)';
                    });
                    
                    lessonCard.addEventListener('touchend', function() {
                        this.style.transform = 'scale(1)';
                    });
                }
                
                container.appendChild(lessonCard);
            });
        }
        
        function renderLesson() {
            if (!currentLesson) return;
            
            document.getElementById('lesson-emoji').textContent = currentLesson.emoji;
            document.getElementById('lesson-title').textContent = currentLesson.title;
            document.getElementById('lesson-concept').textContent = currentLesson.concept;
            document.getElementById('lesson-explanation').textContent = currentLesson.explanation;
            document.getElementById('example-query').textContent = currentLesson.example_query;
            document.getElementById('example-explanation').textContent = currentLesson.example_explanation;
            
            // Render sample data table
            renderSampleData();
            
            // Render syntax breakdown
            renderSyntaxBreakdown();
        }
        
        function renderSampleData() {
            if (!currentLesson) return;
            
            const tableData = sampleData[currentLesson.sampleTable];
            const tableContainer = document.getElementById('data-table');
            
            if (!tableData || tableData.length === 0) {
                tableContainer.innerHTML = '<p class="text-gray-500">No sample data available</p>';
                return;
            }
            
            const headers = Object.keys(tableData[0]);
            
            let tableHTML = `
                <table class="min-w-full bg-white rounded-lg overflow-hidden shadow">
                    <thead class="bg-yellow-200">
                        <tr>
                            ${headers.map(header => `<th class="px-4 py-3 text-left font-semibold text-yellow-800 capitalize">${header}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            tableData.forEach((row, index) => {
                tableHTML += `
                    <tr class="${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}">
                        ${headers.map(header => `<td class="px-4 py-3 text-gray-700">${row[header]}</td>`).join('')}
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            tableContainer.innerHTML = tableHTML;
        }
        
        function renderSyntaxBreakdown() {
            if (!currentLesson || !currentLesson.syntax_breakdown) return;
            
            const breakdownContainer = document.getElementById('breakdown-content');
            breakdownContainer.innerHTML = '';
            
            currentLesson.syntax_breakdown.forEach(item => {
                const breakdownItem = document.createElement('div');
                breakdownItem.className = 'syntax-item flex items-center gap-3 p-3 bg-white rounded-lg shadow-sm';
                
                breakdownItem.innerHTML = `
                    <div class="${item.color} text-white px-3 py-2 rounded-lg font-mono font-bold text-sm">
                        ${item.part}
                    </div>
                    <div class="text-gray-700 flex-1">
                        <span class="font-medium">${item.part}:</span> ${item.explanation}
                    </div>
                `;
                
                breakdownContainer.appendChild(breakdownItem);
            });
        }
        
        // Quiz Functions
        function startQuiz() {
            document.getElementById('explanation-phase').classList.add('hidden');
            document.getElementById('quiz-phase').classList.remove('hidden');
            setupQuiz();
        }
        
        function setupQuiz() {
            if (!currentLesson) return;
            
            const partsContainer = document.getElementById('quiz-parts');
            const dropZone = document.getElementById('drop-zone');
            
            // Reset quiz state
            droppedParts = [];
            usedParts.clear();
            document.getElementById('check-btn').disabled = true;
            document.getElementById('result-message').classList.add('hidden');
            document.getElementById('drop-hint').classList.remove('hidden');
            
            // Clear containers
            partsContainer.innerHTML = '';
            dropZone.innerHTML = '<div class="flex flex-wrap gap-2 justify-center items-center min-h-12"><p class="text-gray-500 text-center w-full" id="drop-hint">Drag query parts here (arrange horizontally)</p></div>';
            
            // Shuffle quiz parts
            const shuffledParts = [...currentLesson.quiz_parts].sort(() => Math.random() - 0.5);
            
            // Create draggable parts - ALL START AS ACTIVE/ENABLED
            shuffledParts.forEach((part, index) => {
                const partElement = document.createElement('div');
                partElement.className = `quiz-card ${part.color} text-white px-4 py-3 rounded-lg font-mono font-bold shadow-lg transition-all duration-300`;
                partElement.textContent = part.text;
                partElement.dataset.order = part.order;
                partElement.dataset.text = part.text;
                partElement.dataset.color = part.color;
                partElement.id = `part-${part.text.replace(/\s+/g, '-')}`;
                partsContainer.appendChild(partElement);
            });
            
            // Setup Sortable for Available Parts - these get disabled when used
            if (sortableInstance) {
                sortableInstance.destroy();
            }
            
            sortableInstance = Sortable.create(partsContainer, {
                group: { name: 'quiz', pull: 'clone', put: false },
                sort: false,
                filter: '.disabled', // Prevent dragging disabled elements
                preventOnFilter: false,
                // Mobile-specific touch settings
                delay: 150, // Delay before drag starts (helps with scrolling on mobile)
                delayOnTouchOnly: true, // Only apply delay on touch devices
                touchStartThreshold: 5, // px, how many pixels the point should move before cancelling a delayed drag event
                forceFallback: false, // Always use native HTML5 drag and drop
                fallbackOnBody: true, // Appends the cloned DOM Element into the Document's Body
                dragoverBubble: true, // Apply bubble for dragover event
                animation: 200, // Animation speed in ms
                easing: "cubic-bezier(1, 0, 0, 1)", // Easing for animation
                onStart: function(evt) {
                    // Double-check: prevent dragging if already used
                    if (usedParts.has(evt.item.dataset.text)) {
                        return false;
                    }
                    // Add haptic-style feedback
                    evt.item.style.transform = 'scale(1.05) rotate(2deg)';
                    
                    // Vibrate on mobile if supported
                    if (navigator.vibrate) {
                        navigator.vibrate(50);
                    }
                },
                onEnd: function(evt) {
                    // Reset transform
                    evt.item.style.transform = '';
                },
                onClone: function(evt) {
                    // Prevent cloning if part is already used (prevent duplicates)
                    if (usedParts.has(evt.item.dataset.text)) {
                        evt.preventDefault();
                        return false;
                    }
                    // CRITICAL: Ensure cloned item (going to Build Query) is FULLY ACTIVE
                    evt.clone.classList.remove('disabled', 'opacity-30', 'cursor-not-allowed');
                    evt.clone.style.pointerEvents = 'auto';
                    evt.clone.title = '';
                    // Visual feedback for cloned item
                    evt.clone.classList.add('opacity-75');
                    
                    // Haptic feedback for successful clone
                    if (navigator.vibrate) {
                        navigator.vibrate([50, 30, 50]);
                    }
                }
            });
            
            // Setup Sortable for Build Query Area - ALWAYS STAYS ACTIVE
            const dropZoneElement = dropZone.querySelector('div') || dropZone;
            Sortable.create(dropZoneElement, {
                group: 'quiz',
                direction: 'horizontal',
                animation: 250, // Smooth reordering animation
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                // Mobile-optimized settings
                delay: 100,
                delayOnTouchOnly: true,
                touchStartThreshold: 10,
                forceFallback: false,
                fallbackOnBody: true,
                dragoverBubble: true,
                swapThreshold: 0.8, // Threshold for swap
                invertSwap: true, // Will always use inverted swap zone
                easing: "cubic-bezier(0.25, 0.46, 0.45, 0.94)",
                onStart: function(evt) {
                    // Haptic feedback when starting drag in build area
                    if (navigator.vibrate) {
                        navigator.vibrate(30);
                    }
                },
                onAdd: function(evt) {
                    // Hide the hint text
                    const hint = document.getElementById('drop-hint');
                    if (hint) hint.classList.add('hidden');
                    
                    const partText = evt.item.dataset.text;
                    
                    // Prevent duplicates - if somehow a duplicate gets through
                    if (usedParts.has(partText)) {
                        evt.item.remove();
                        return;
                    }
                    
                    const newPart = {
                        text: partText,
                        order: parseInt(evt.item.dataset.order)
                    };
                    
                    droppedParts.push(newPart);
                    usedParts.add(partText);
                    
                    // CRITICAL FIX: Ensure the dropped element in Build Query stays FULLY ACTIVE
                    evt.item.classList.remove('disabled', 'opacity-30', 'cursor-not-allowed');
                    evt.item.style.pointerEvents = 'auto';
                    evt.item.title = '';
                    
                    // DISABLE ONLY the corresponding element in Available Parts (not the dropped one)
                    const originalPart = document.getElementById(`part-${partText.replace(/\s+/g, '-')}`);
                    if (originalPart && originalPart !== evt.item) {
                        originalPart.classList.add('disabled', 'opacity-30', 'cursor-not-allowed');
                        originalPart.style.pointerEvents = 'none';
                        originalPart.title = 'This part is already used in your query';
                    }
                    
                    // Success haptic feedback
                    if (navigator.vibrate) {
                        navigator.vibrate([70, 30, 70]);
                    }
                    
                    // Enable check button
                    document.getElementById('check-btn').disabled = droppedParts.length === 0;
                },
                onRemove: function(evt) {
                    const partText = evt.item.dataset.text;
                    droppedParts = droppedParts.filter(part => part.text !== partText);
                    usedParts.delete(partText);
                    
                    // RE-ENABLE the corresponding element in Available Parts
                    const originalPart = document.getElementById(`part-${partText.replace(/\s+/g, '-')}`);
                    if (originalPart) {
                        originalPart.classList.remove('disabled', 'opacity-30', 'cursor-not-allowed');
                        originalPart.style.pointerEvents = 'auto';
                        originalPart.title = '';
                    }
                    
                    // Light haptic feedback for removal
                    if (navigator.vibrate) {
                        navigator.vibrate(40);
                    }
                    
                    // Show hint if no parts left
                    if (droppedParts.length === 0) {
                        const hint = document.getElementById('drop-hint');
                        if (hint) hint.classList.remove('hidden');
                        document.getElementById('check-btn').disabled = true;
                    }
                },
                onUpdate: function(evt) {
                    // Handle reordering within Build Query area
                    // Update the droppedParts array to match new DOM order
                    const newOrder = [];
                    Array.from(evt.to.children).forEach(child => {
                        if (child.dataset && child.dataset.text) {
                            const part = droppedParts.find(p => p.text === child.dataset.text);
                            if (part) {
                                newOrder.push(part);
                            }
                        }
                    });
                    droppedParts = newOrder;
                    
                    // Subtle haptic feedback for reordering
                    if (navigator.vibrate) {
                        navigator.vibrate(25);
                    }
                    
                    // Debug log for reordering
                    console.log('🔄 Parts reordered:', droppedParts.map(p => p.text));
                }
            });
        }
        
        function checkAnswer() {
            if (!currentLesson || droppedParts.length === 0) return;
            
            // CRITICAL FIX: Get the actual sortable container and current order
            const dropZone = document.getElementById('drop-zone');
            const sortableContainer = dropZone.querySelector('div') || dropZone;
            
            // Get current elements in their DOM order (how user arranged them)
            const currentElements = Array.from(sortableContainer.children)
                .filter(child => child.dataset && child.dataset.order && child.dataset.text)
                .map(child => ({
                    text: child.dataset.text.trim(),
                    order: parseInt(child.dataset.order)
                }));
            
            // Get the correct order from lesson data
            const correctOrder = currentLesson.quiz_parts
                .sort((a, b) => a.order - b.order)
                .map(part => part.text.trim());
            
            // Get user's current order (based on DOM position)
            const userOrder = currentElements.map(el => el.text);
            
            // DEBUG LOGS for troubleshooting
            console.log('🐛 DEBUG - User Order:', userOrder);
            console.log('🐛 DEBUG - Correct Order:', correctOrder);
            console.log('🐛 DEBUG - Arrays Match:', JSON.stringify(userOrder) === JSON.stringify(correctOrder));
            
            // Additional validation checks
            const hasAllParts = userOrder.length === correctOrder.length;
            const hasCorrectParts = correctOrder.every(part => userOrder.includes(part));
            const isCorrectSequence = userOrder.every((text, index) => text === correctOrder[index]);
            
            // Check if arrays match exactly (length and sequence)
            const isCorrect = hasAllParts && hasCorrectParts && isCorrectSequence;
            
            // Additional debug info
            console.log('🐛 DEBUG - Has All Parts:', hasAllParts, `(${userOrder.length}/${correctOrder.length})`);
            console.log('🐛 DEBUG - Has Correct Parts:', hasCorrectParts);
            console.log('🐛 DEBUG - Correct Sequence:', isCorrectSequence);
            console.log('🐛 DEBUG - Final Result:', isCorrect);
            
            const resultMessage = document.getElementById('result-message');
            
            if (isCorrect) {
                // Success!
                resultMessage.className = 'mt-6 text-center p-4 rounded-lg font-bold text-lg bg-green-100 text-green-800';
                resultMessage.textContent = '🎉 Fantastic! You\'ve mastered this query! 🎉';
                resultMessage.classList.remove('hidden');
                
                // Add to completed lessons
                if (!userProgress.completed.includes(currentLesson.id)) {
                    userProgress.completed.push(currentLesson.id);
                    userProgress.xp += 100;
                }
                
                // Unlock next lesson
                if (currentLesson.id < lessons.length) {
                    const nextLesson = lessons.find(l => l.id === currentLesson.id + 1);
                    if (nextLesson) {
                        nextLesson.locked = false;
                    }
                }
                
                // Confetti animation
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
                
                // Add pulse animation to all dropped parts
                Array.from(dropZone.children).forEach(child => {
                    if (child.dataset.order) {
                        child.classList.add('correct');
                    }
                });
                
                // Show continue button after a delay
                setTimeout(() => {
                    resultMessage.innerHTML += '<br><button onclick="showLessons()" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full transition-all duration-300">Continue Learning! 🚀</button>';
                }, 2000);
                
            } else {
                // Incorrect
                resultMessage.className = 'mt-6 text-center p-4 rounded-lg font-bold text-lg bg-red-100 text-red-800';
                
                // Enhanced error message based on specific issue
                let errorMessage = '🤔 Not quite right!';
                
                if (!hasAllParts) {
                    if (userOrder.length < correctOrder.length) {
                        errorMessage = '🔍 You\'re missing some parts! Make sure to drag all the required pieces.';
                    } else {
                        errorMessage = '👀 You have too many parts! You might have duplicates.';
                    }
                } else if (!hasCorrectParts) {
                    errorMessage = '🔄 You have the right number of parts, but some are incorrect.';
                } else if (!isCorrectSequence) {
                    errorMessage = '🎢 You have all the right parts, but they\'re in the wrong order!';
                }
                
                const debugInfo = `
                    <div class="mb-4">
                        <p class="text-lg font-bold mb-2">${errorMessage}</p>
                        <p class="text-sm mb-3">Remember, SQL queries have a specific order!</p>
                    </div>
                    <div class="bg-white/20 rounded-lg p-3 text-sm">
                        <div class="mb-2"><strong>Your order:</strong> ${userOrder.length > 0 ? userOrder.join(' → ') : '(empty)'}</div>
                        <div><strong>Correct order:</strong> ${correctOrder.join(' → ')}</div>
                    </div>
                `;
                
                resultMessage.innerHTML = debugInfo;
                resultMessage.classList.remove('hidden');
                
                // Shake animation for incorrect parts
                Array.from(dropZone.children).forEach(child => {
                    if (child.dataset.order) {
                        child.style.animation = 'shake 0.5s ease-in-out';
                        setTimeout(() => {
                            child.style.animation = '';
                        }, 500);
                    }
                });
            }
        }
        
        function updateProgress() {
            document.getElementById('xp-display').textContent = userProgress.xp;
            const progressPercentage = Math.min((userProgress.completed.length / lessons.length) * 100, 100);
            document.getElementById('progress-bar').style.width = progressPercentage + '%';
        }
        
        // Add shake animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes shake {
                0%, 20%, 40%, 60%, 80%, 100% { transform: translateX(0); }
                10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
            }
        `;
        document.head.appendChild(style);
        
        // Mobile detection and optimization
        function isMobileDevice() {
            return (typeof window.orientation !== "undefined") || (navigator.userAgent.indexOf('IEMobile') !== -1);
        }
        
        function isTabletDevice() {
            return /(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(navigator.userAgent);
        }
        
        function isTouchDevice() {
            return (('ontouchstart' in window) || (navigator.maxTouchPoints > 0) || (navigator.msMaxTouchPoints > 0));
        }
        
        // Add mobile-specific classes to body
        function addMobileClasses() {
            const body = document.body;
            
            if (isMobileDevice()) {
                body.classList.add('mobile-device');
            }
            
            if (isTabletDevice()) {
                body.classList.add('tablet-device');
            }
            
            if (isTouchDevice()) {
                body.classList.add('touch-device');
            }
            
            // Add viewport height fix for mobile browsers
            function setViewportHeight() {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            }
            
            setViewportHeight();
            window.addEventListener('resize', setViewportHeight);
            window.addEventListener('orientationchange', function() {
                setTimeout(setViewportHeight, 100);
            });
        }
        
        // Enhanced touch feedback
        function addTouchFeedback() {
            // Add touch feedback to all interactive elements
            document.addEventListener('touchstart', function(e) {
                if (e.target.matches('button, .btn, .quiz-card, .lesson-card, [onclick]')) {
                    e.target.style.transform = 'scale(0.95)';
                    e.target.style.transition = 'transform 0.1s ease';
                }
            }, { passive: true });
            
            document.addEventListener('touchend', function(e) {
                if (e.target.matches('button, .btn, .quiz-card, .lesson-card, [onclick]')) {
                    setTimeout(() => {
                        e.target.style.transform = '';
                    }, 100);
                }
            }, { passive: true });
            
            document.addEventListener('touchcancel', function(e) {
                if (e.target.matches('button, .btn, .quiz-card, .lesson-card, [onclick]')) {
                    e.target.style.transform = '';
                }
            }, { passive: true });
        }
        
        // Prevent zoom on double tap for better touch experience
        function preventDoubleZoom() {
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function(event) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, { passive: false });
        }
        
        // Add scroll enhancement for mobile
        function enhanceScrolling() {
            // Smooth scrolling for mobile
            document.documentElement.style.scrollBehavior = 'smooth';
            
            // Prevent rubber band scrolling on iOS
            document.body.addEventListener('touchmove', function(e) {
                if (e.target === document.body) {
                    e.preventDefault();
                }
            }, { passive: false });
        }
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            addMobileClasses();
            
            if (isTouchDevice()) {
                addTouchFeedback();
                preventDoubleZoom();
                enhanceScrolling();
                
                // Add additional mobile-specific optimizations
                document.body.style.webkitTapHighlightColor = 'transparent';
                document.body.style.webkitTouchCallout = 'none';
                document.body.style.webkitUserSelect = 'none';
            }
            
            showHomepage();
        });
    </script>
</body>
</html>
